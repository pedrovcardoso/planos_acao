<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Consulta de Logs</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body {
      font-family: 'Inter', sans-serif;
    }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #18181b; } /* zinc-900 */
    ::-webkit-scrollbar-thumb { background: #52525b; border-radius: 4px; } /* zinc-600 */
    ::-webkit-scrollbar-thumb:hover { background: #71717a; } /* zinc-500 */
  </style>
</head>
<body class="bg-black text-zinc-300 min-h-screen flex flex-col items-center p-4 sm:p-6 lg:p-8">

  <div class="w-full max-w-7xl mx-auto">
    <h1 class="text-3xl font-bold text-zinc-100 mb-6">Consulta de Logs</h1>

    <!-- Filtros -->
    <div class="bg-zinc-900 p-4 rounded-lg shadow-md mb-6 flex flex-wrap items-center gap-4 border border-zinc-800">
      <input 
        type="text" 
        id="searchInput" 
        placeholder="Pesquisar por arquivo, ID ou conteúdo..." 
        class="flex-1 min-w-[200px] bg-zinc-800 text-zinc-200 border border-zinc-700 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-zinc-500 focus:border-zinc-500"
      >
      <select id="eventFilter" class="bg-zinc-800 text-zinc-200 border border-zinc-700 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-zinc-500 focus:border-zinc-500">
        <option value="">Todos os eventos</option>
        <option value="create">Create</option>
        <option value="update">Update</option>
        <option value="delete">Delete</option>
      </select>
    </div>

    <!-- Tabela -->
    <div class="overflow-x-auto bg-zinc-900 rounded-lg shadow-lg border border-zinc-800">
      <table class="min-w-full divide-y divide-zinc-800">
        <thead class="bg-zinc-800/50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase tracking-wider">Data/Hora</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase tracking-wider">Evento</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase tracking-wider">Arquivo</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase tracking-wider">ID</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-zinc-400 uppercase tracking-wider">Ação</th>
          </tr>
        </thead>
        <tbody id="logTable" class="divide-y divide-zinc-800">
          <!-- Conteúdo dinâmico: Loading, Erro, Dados ou "Nenhum resultado" -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 transition-opacity duration-300">
    <div class="bg-zinc-900 rounded-xl shadow-2xl p-6 max-w-2xl w-full relative border border-zinc-700 m-4">
      <button id="closeModal" class="absolute top-3 right-3 text-zinc-400 hover:text-white text-2xl font-bold transition-colors">✕</button>
      <h2 class="text-xl font-semibold text-zinc-100 mb-4">Visualizar Conteúdo do Log</h2>
      <pre id="modalContent" class="bg-black text-zinc-300 p-4 rounded-md whitespace-pre-wrap word-wrap break-word max-h-[60vh] overflow-y-auto border border-zinc-800"></pre>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      let logs = [];

      const tableBody = document.getElementById("logTable");
      const searchInput = document.getElementById("searchInput");
      const eventFilter = document.getElementById("eventFilter");
      const modal = document.getElementById("modal");
      const modalContent = document.getElementById("modalContent");
      const closeModalBtn = document.getElementById("closeModal");

      const eventClasses = {
        'create': 'bg-green-500/10 text-green-400',
        'update': 'bg-yellow-500/10 text-yellow-400',
        'delete': 'bg-red-500/10 text-red-400'
      };

      function formatDateTime(dtStr) {
        const d = new Date(dtStr);
        const pad = n => n.toString().padStart(2, '0');
        return `${pad(d.getDate())}/${pad(d.getMonth() + 1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      }

      function displayTableMessage(message, isError = false) {
        const textColor = isError ? 'text-red-400' : 'text-zinc-500';
        tableBody.innerHTML = `
          <tr>
            <td colspan="5" class="text-center p-8 ${textColor}">
              ${message}
            </td>
          </tr>
        `;
      }

      function renderLogs() {
        if (!logs) {
          displayTableMessage("Nenhum log para exibir.", true);
          return;
        }

        const search = searchInput.value.toLowerCase();
        const filter = eventFilter.value;
        tableBody.innerHTML = "";

        const filteredLogs = logs.filter(log => {
          const searchString = `${log.arquivo} ${log.id} ${Object.values(log.novoConteudo).join(' ')}`.toLowerCase();
          const matchSearch = searchString.includes(search);
          const matchEvent = filter === "" || log.evento === filter;
          return matchSearch && matchEvent;
        });

        if (filteredLogs.length === 0) {
            displayTableMessage("Nenhum resultado corresponde à sua pesquisa.");
            return;
        }

        filteredLogs.forEach(log => {
          const tr = document.createElement("tr");
          tr.className = "hover:bg-zinc-800/60 transition-colors duration-150";
          const eventClass = eventClasses[log.evento] || 'bg-zinc-500/10 text-zinc-400';

          tr.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm text-zinc-300">${formatDateTime(log.dataHora)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
              <span class="px-2.5 py-0.5 rounded-full text-xs font-semibold ${eventClass}">${log.evento}</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-zinc-300">${log.arquivo}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-zinc-400 font-mono">${log.id}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm">
              <button data-content='${JSON.stringify(log.novoConteudo)}' class="view-btn bg-zinc-700 text-zinc-100 px-3 py-1 rounded-md text-xs font-semibold hover:bg-zinc-600 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-zinc-900 focus:ring-zinc-500">
                Exibir
              </button>
            </td>
          `;
          tableBody.appendChild(tr);
        });
      }

      function showModal(content) {
        modalContent.textContent = Object.keys(content).length > 0 ? JSON.stringify(content, null, 2) : "Não há conteúdo para exibir.";
        modal.classList.remove("hidden");
        document.body.classList.add('overflow-hidden'); // <-- ADICIONADO AQUI
      }

      function hideModal() {
        modal.classList.add("hidden");
        document.body.classList.remove('overflow-hidden'); // <-- ADICIONADO AQUI
      }
      
      async function obterLogDoOneDrive(arrFiles) {
        displayTableMessage("Carregando logs...");
        const powerAutomateUrl = "https://default4c86fd71d0164231a16057311d68b9.51.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/9019b15756f14c698b3ea71554389290/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=VNrk0XHX2XqG_nLsuzcYmPJP4kGUFifRX2c4FC_sc4w";
        const dadosParaEnviar = { files: arrFiles };

        try {
          const response = await fetch(powerAutomateUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dadosParaEnviar)
          });

          if (!response.ok) {
            throw new Error(`Erro na requisição: ${response.statusText}`);
          }
          
          const data = await response.json();
          logs = data[0];
          jsonPlanos = data[1];
          renderLogs();

        } catch (error) {
          console.error("Falha ao obter os dados do Power Automate:", error);
          displayTableMessage("Falha ao carregar os logs.", true);
        }
      }

      // --- Event Listeners ---
      searchInput.addEventListener("input", renderLogs);
      eventFilter.addEventListener("change", renderLogs);
      
      closeModalBtn.addEventListener("click", hideModal);
      modal.addEventListener("click", e => { if (e.target === modal) hideModal(); });
      document.addEventListener('keydown', e => { if (e.key === "Escape") hideModal(); });

      // Adiciona um listener delegado para os botões "Exibir"
      tableBody.addEventListener('click', (e) => {
        if (e.target.classList.contains('view-btn')) {
            const content = JSON.parse(e.target.dataset.content);
            showModal(content);
        }
      });
      
      // Inicia a busca de dados
      obterLogDoOneDrive(['log.txt', 'planos.txt']);
    });
  </script>
</body>
</html>